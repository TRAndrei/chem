<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Chem</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.18.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>

<body>

    <script type="text/javascript">
        var w = 1920
        var h = 965
        var config = {
            type: Phaser.AUTO,
            width: w,
            height: h,
            physics: {
                default: 'matter',
                matter: {
                    gravity: 0,
                    debug: true
                }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        }

        var game = new Phaser.Game(config)
        var graphics
        var platforms
        var cursors
        var score = 0;
        var scoreText;

        function preload() {
            this.load.image('element', 'assets/red circle.png');
            this.load.json('levelData', 'assets/levelData.json');
        }

        function create() {

            var worldBounds = new Phaser.Geom.Rectangle(0, 0, (w * 4), (h * 4));

            this.matter.world.setBounds(0, 0, worldBounds.width, worldBounds.height, 100).disableGravity();

            var controlConfig = {
                camera: this.cameras.main,
                left: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.A),
                right: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.D),
                up: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.W),
                down: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S),
                zoomIn: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Q),
                zoomOut: this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E),
                speed: 1,
                acceleration: 0.05,
                drag: 0.0,
                maxSpeed: 10.0,
                zoom: 0.3
            };

            this.graphics = this.add.graphics()

            controls = new Phaser.Cameras.Controls.FixedKeyControl(controlConfig);
            this.cameras.main.setBounds(-450, -450, worldBounds.width + 450, worldBounds.height + 450, true)
            this.input.on('wheel', function (pointer, currentlyOver, dx, dy, dz, event) {
                zoom_mousewheel(this.cameras.main, pointer, currentlyOver, dx, dy, dz, event);
            })

            var worldCamera = this.cameras.main;

            this.matter.add.mouseSpring();

            // load elements and rules
            var levelData = this.cache.json.get('levelData');
            createLevel(levelData)
            

            for (var i = 0; i < 50; i++) {
                new Element(this, "E0", Phaser.Math.Between(50, worldBounds.width - 50), Phaser.Math.Between(50, worldBounds.height - 50), 0)
            }

            this.matter.world.on('collisionstart', function (event, bodyA, bodyB) {
                if (bodyA.gameObject && bodyB.gameObject) {
                    if (bodyA.gameObject.getText() == bodyB.gameObject.getText())
                        this.scene.matter.add.joint(bodyA, bodyB, 95, 0.99);
                }

            });
        }

        function update(time, delta) {
            controls.update(delta);
        }

        function createLevel(levelData) {
            var scene = game.scene.scenes[0]
            var elementMap = new Map()

            levelData.elements.forEach(elem => elementMap.set(elem.id, new Element(scene, elem.type, elem.x, elem.y, 0)))

            levelData.connections.forEach(conn => scene.matter.add.joint(elementMap.get(conn.first), elementMap.get(conn.second), 95, 0.99))
        }

        function zoom_mousewheel(camera, pointer, currentlyOver, dx, dy, dz, event) {
            var wheelDelt = - dy * 0.01;
            var delt = Math.max(-1, Math.min(1, (wheelDelt)));

            var centerPoint = camera.midPoint

            var xAdjust = (pointer.x - camera.centerX) * delt;
            var yAdjust = (pointer.y - camera.centerY) * delt;

            var deltaZoom = (2 * camera.zoom * camera.zoom * xAdjust) / (2 * pointer.x - camera.width - 2 * camera.zoom * xAdjust)
            var newZoom = camera.zoom + deltaZoom
            if (isFinite(deltaZoom) && newZoom < 4 && newZoom > 0.20) {
                camera.zoom += deltaZoom
                camera.scrollX += xAdjust;
                camera.scrollY += yAdjust
            }
           
            console.log("Mx " + pointer.worldX + " My " + pointer.worldY + " x " + camera.scrollX + " y " + camera.scrollY)
        }

        class Element extends Phaser.GameObjects.Container {
            constructor(scene, type, x, y, maxSpeed) {
                var text = scene.add.text(-10, 0, type, { font: '12px Arial', fill: '#00ff00' });
                var picture = scene.add.image(0, 0, 'element');
                super(scene, x, y, [picture, text]);
                // ...
                scene.add.existing(this);
                this.setSize(50, 50);

                this.textObj = text
                this.physicsContainer = scene.matter.add.gameObject(this, { shape: { type: 'circle', radius: 25 } });

                this.setFrictionAir(0).setFriction(0).setBounce(1).setMass(1);
                this.setVelocity(Phaser.Math.Between(-maxSpeed, maxSpeed), Phaser.Math.Between(-maxSpeed, maxSpeed))
            }

            getText() {
                return this.textObj.text
            }

            setText(text) {
                this.textObj.setText(text)
            }
        }
    </script>

</body>

</html>